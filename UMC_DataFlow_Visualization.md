# UMC项目数据流图 - 可视化版本

## 1. 整体数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                UMC 数据流架构                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

输入数据层                   特征提取层                   多模态融合层                   聚类学习层                   输出结果层
    │                          │                          │                          │                          │
    ▼                          ▼                          ▼                          ▼                          ▼
┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
│  文本数据   │            │  BERT编码   │            │  ConFEDE    │            │  K-means    │            │   评估指标  │
│ train.tsv   │───────────▶│ [B,3,L]    │───────────▶│ 双投影机制  │───────────▶│ 聚类算法    │───────────▶│ NMI/ARI/ACC │
│ dev.tsv     │            │ [B,L,768]  │            │ 注意力融合  │            │ 样本选择    │            │ FMI         │
│ test.tsv    │            │ [B,L,256]  │            │ 门控融合    │            │ 对比学习    │            │             │
└─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘
    │                          │                          │                          │                          │
    ▼                          ▼                          ▼                          ▼                          ▼
┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
│  视频数据   │            │ Swin特征    │            │ 文本引导   │            │ 渐进式学习  │            │   结果保存  │
│swin_feats   │───────────▶│ [B,L,256]   │───────────▶│ 交叉注意力  │───────────▶│ 自适应阈值  │───────────▶│ CSV格式     │
│ .pkl        │            │ Transformer │            │ 自注意力层  │            │ 早停机制    │            │ 统计分析    │
└─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘
    │                          │                          │                          │                          │
    ▼                          ▼                          ▼                          ▼                          ▼
┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
│  音频数据   │            │ WavLM特征   │            │ 特征交互   │            │ 损失函数    │            │   模型保存  │
│wavlm_feats  │───────────▶│ [B,L,768]   │───────────▶│ 层融合     │───────────▶│ 组合优化    │───────────▶│ 检查点     │
│ .pkl        │            │ Transformer │            │ LayerNorm  │            │ 反向传播    │            │ 预训练模型  │
└─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘            └─────────────┘
```

## 2. 详细数据流处理图

### 2.1 特征提取阶段

```
原始输入数据
    │
    ├── 文本数据 [B, 3, L] (input_ids, attention_mask, token_type_ids)
    │   │
    │   └── BERTEncoder
    │       │
    │       └── 文本特征 [B, L, 768]
    │           │
    │           └── Linear投影 [B, L, 256]
    │
    ├── 视频数据 [B, L, 256] (预提取Swin特征)
    │   │
    │   └── Transformer编码器
    │       │
    │       └── 视频特征 [B, L, 256]
    │
    └── 音频数据 [B, L, 768] (预提取WavLM特征)
        │
        └── Transformer编码器 + Linear投影
            │
            └── 音频特征 [B, L, 256]
```

### 2.2 多模态融合阶段

```
三个模态特征 [B, L, 256]
    │
    ├── ConFEDE机制 (可选)
    │   │
    │   ├── VideoDualProjector
    │   │   ├── simi_proj: 主要信息 [B, L, 256]
    │   │   ├── dissimi_proj: 环境信息 [B, L, 256]
    │   │   └── fusion: 双投影融合 [B, L, 256]
    │   │
    │   └── AudioDualProjector
    │       ├── simi_proj: 语音内容 [B, L, 256]
    │       ├── dissimi_proj: 环境音 [B, L, 256]
    │       └── fusion: 双投影融合 [B, L, 256]
    │
    ├── 注意力机制
    │   │
    │   ├── 文本引导交叉注意力
    │   │   ├── text_guided_video_attn: [B, L, 256]
    │   │   └── text_guided_audio_attn: [B, L, 256]
    │   │
    │   ├── 自注意力层 (2层)
    │   │   └── self_attention_layers: [B, L, 256]
    │   │
    │   └── 特征交互层
    │       └── feature_interaction: [B, L, 256]
    │
    ├── 门控融合机制
    │   │
    │   ├── 权重计算
    │   │   ├── text_weight: Sigmoid([B, L, 256] → [B, L, 1])
    │   │   ├── video_weight: Sigmoid([B, L, 256] → [B, L, 1])
    │   │   └── audio_weight: Sigmoid([B, L, 256] → [B, L, 1])
    │   │
    │   └── 加权融合
    │       └── w1*text + w2*video + w3*audio: [B, L, 256]
    │
    └── 最终融合
        │
        ├── shared_embedding_layer: GELU + Dropout + Linear
        ├── fusion_layer: GELU + Dropout + Linear
        ├── LayerNorm归一化
        └── 融合特征 [B, L, 256]
```

### 2.3 聚类学习阶段

```
融合特征 [B, L, 256]
    │
    ├── 特征池化
    │   │
    │   └── 注意力池化: [B, L, 256] → [B, 256]
    │
    ├── 高质量样本选择 (ConvexSampler)
    │   │
    │   ├── K-means++初始化
    │   │   ├── 聚类中心: [K, 256]
    │   │   └── 样本分配: [N] labels
    │   │
    │   ├── 距离计算
    │   │   ├── 样本到中心距离: [N, K]
    │   │   └── 最近邻距离: [N]
    │   │
    │   ├── 动态阈值选择
    │   │   ├── 阈值范围: [0.05, 0.5]
    │   │   ├── 自适应调整: S型曲线
    │   │   └── 高质量样本: select_ids
    │   │
    │   └── 伪标签生成
    │       └── pseudo_labels: [N]
    │
    ├── 对比学习损失
    │   │
    │   ├── InstanceLoss (实例级)
    │   │   ├── 正样本: 同一实例不同视图
    │   │   ├── 负样本: 不同实例
    │   │   ├── 温度: 0.07
    │   │   └── 损失: [B]
    │   │
    │   ├── ClusterLoss (聚类级)
    │   │   ├── 正样本: 同一聚类不同视图
    │   │   ├── 负样本: 不同聚类
    │   │   ├── 熵正则化
    │   │   └── 损失: [B]
    │   │
    │   └── SupConLoss (监督对比)
    │       ├── 温度: 1.4 (监督), 1.0 (无监督)
    │       ├── 多视图对比
    │       └── 损失: [B]
    │
    ├── 聚类优化损失 (可选)
    │   │
    │   ├── CompactnessLoss (紧密度)
    │   │   ├── 类内距离计算
    │   │   ├── Margin: 0.3
    │   │   └── 损失: scalar
    │   │
    │   ├── SeparationLoss (分离度)
    │   │   ├── 类间距离计算
    │   │   ├── Margin: 0.8
    │   │   └── 损失: scalar
    │   │
    │   └── 总聚类损失
    │       └── compactness + separation: scalar
    │
    └── 渐进式学习优化
        │
        ├── AdaptiveProgressiveLearning
        │   ├── 性能历史记录
        │   ├── 阈值历史记录
        │   └── 损失历史记录
        │
        ├── 自适应阈值计算
        │   ├── 基础阈值: S型曲线
        │   ├── 性能调整
        │   ├── 损失调整
        │   └── 稳定性调整
        │
        ├── 早停机制
        │   ├── 性能窗口: 3
        │   ├── 耐心值: 5
        │   └── 稳定性检查
        │
        └── 训练统计
            ├── 最佳性能
            ├── 改进次数
            └── 性能趋势
```

### 2.4 训练流程阶段

```
训练流程
    │
    ├── 预训练阶段 (可选)
    │   │
    │   ├── 参数设置
    │   │   ├── 冻结BERT (除最后2层)
    │   │   ├── 学习率: 2e-5
    │   │   ├── 温度: 0.2
    │   │   └── 轮数: 100
    │   │
    │   ├── 对比学习预训练
    │   │   ├── 实例级对比
    │   │   ├── 聚类级对比
    │   │   └── 多模态对比
    │   │
    │   └── 模型保存
    │       └── 预训练检查点
    │
    ├── 主训练阶段
    │   │
    │   ├── 参数设置
    │   │   ├── 冻结BERT (除最后2层)
    │   │   ├── 学习率: 3e-4
    │   │   ├── 批次大小: 128
    │   │   └── 轮数: 100
    │   │
    │   ├── 每个Epoch流程
    │   │   │
    │   │   ├── 聚类初始化
    │   │   │   ├── K-means++ (首次)
    │   │   │   └── 中心初始化 (后续)
    │   │   │
    │   │   ├── 高质量样本选择
    │   │   │   ├── 计算距离
    │   │   │   ├── 阈值选择
    │   │   │   └── 样本筛选
    │   │   │
    │   │   ├── 伪标签生成
    │   │   │   ├── 聚类分配
    │   │   │   └── 标签更新
    │   │   │
    │   │   ├── 监督学习 (高质量样本)
    │   │   │   ├── 前向传播
    │   │   │   ├── 损失计算
    │   │   │   └── 反向传播
    │   │   │
    │   │   ├── 无监督学习 (低质量样本)
    │   │   │   ├── 对比学习
    │   │   │   ├── 聚类优化
    │   │   │   └── 损失组合
    │   │   │
    │   │   └── 参数更新
    │   │       ├── 梯度计算
    │   │       ├── 梯度裁剪
    │   │       └── 参数更新
    │   │
    │   └── 早停检查
    │       ├── 性能监控
    │       ├── 稳定性检查
    │       └── 早停决策
    │
    └── 测试阶段
        │
        ├── 特征提取
        │   ├── 文本特征
        │   ├── 视频特征
        │   └── 音频特征
        │
        ├── 多模态融合
        │   ├── 注意力融合
        │   ├── 门控融合
        │   └── 最终特征
        │
        ├── K-means聚类
        │   ├── 聚类中心
        │   ├── 样本分配
        │   └── 聚类标签
        │
        ├── 评估指标计算
        │   ├── NMI计算
        │   ├── ARI计算
        │   ├── ACC计算
        │   └── FMI计算
        │
        └── 结果保存
            ├── CSV格式
            ├── 统计分析
            └── 模型保存
```

## 3. 数据维度变化图

```
输入数据维度变化:
    │
    ├── 文本数据
    │   ├── 原始: [B, 3, L] (input_ids, attention_mask, token_type_ids)
    │   ├── BERT输出: [B, L, 768]
    │   └── 投影后: [B, L, 256]
    │
    ├── 视频数据
    │   ├── 原始: [B, L, 256] (Swin特征)
    │   └── 处理后: [B, L, 256]
    │
    └── 音频数据
        ├── 原始: [B, L, 768] (WavLM特征)
        └── 投影后: [B, L, 256]

融合过程维度变化:
    │
    ├── 三个模态特征: [B, L, 256]
    │
    ├── ConFEDE处理: [B, L, 256] (每个模态)
    │
    ├── 注意力融合: [B, L, 256]
    │
    ├── 门控融合: [B, L, 256]
    │
    ├── 最终融合: [B, L, 256]
    │
    └── 池化输出: [B, 256]

聚类学习维度变化:
    │
    ├── 特征表示: [B, 256]
    │
    ├── 聚类中心: [K, 256]
    │
    ├── 样本分配: [N] (N个样本)
    │
    ├── 伪标签: [N]
    │
    └── 最终输出: [N] (聚类标签)
```

## 4. 损失函数组合图

```
总损失函数组合:
    │
    ├── 主要损失 (权重: 1.0)
    │   │
    │   ├── 监督对比损失 (SupConLoss)
    │   │   ├── 温度: 1.4
    │   │   ├── 多视图对比
    │   │   └── 损失值: scalar
    │   │
    │   └── 无监督对比损失 (InstanceLoss)
    │       ├── 温度: 1.0
    │       ├── 实例级对比
    │       └── 损失值: scalar
    │
    ├── 辅助损失 (可选)
    │   │
    │   ├── 聚类损失 (权重: 0.1)
    │   │   ├── 紧密度损失: margin=0.3
    │   │   ├── 分离度损失: margin=0.8
    │   │   └── 总聚类损失: scalar
    │   │
    │   └── 对比学习损失 (权重: 0.5)
    │       ├── 温度: 0.07
    │       ├── 硬负样本挖掘
    │       └── 损失值: scalar
    │
    └── 总损失计算
        │
        ├── 监督损失: w1 × SupConLoss
        ├── 无监督损失: w2 × InstanceLoss
        ├── 聚类损失: w3 × ClusteringLoss
        ├── 对比损失: w4 × ContrastiveLoss
        └── 总损失: Σ(wi × Lossi)
```

## 5. 评估指标计算图

```
评估指标计算流程:
    │
    ├── 聚类结果生成
    │   │
    │   ├── K-means聚类
    │   │   ├── 聚类中心: [K, 256]
    │   │   ├── 样本分配: [N]
    │   │   └── 聚类标签: [N]
    │   │
    │   └── 真实标签: [N]
    │
    ├── 指标计算
    │   │
    │   ├── NMI (标准化互信息)
    │   │   ├── 互信息计算
    │   │   ├── 熵计算
    │   │   └── 范围: [0, 1]
    │   │
    │   ├── ARI (调整兰德指数)
    │   │   ├── 兰德指数计算
    │   │   ├── 期望值调整
    │   │   └── 范围: [-1, 1]
    │   │
    │   ├── ACC (聚类准确率)
    │   │   ├── 匈牙利算法对齐
    │   │   ├── 最优匹配
    │   │   └── 范围: [0, 1]
    │   │
    │   └── FMI (Fowlkes-Mallows指数)
    │       ├── 精确率计算
    │       ├── 召回率计算
    │       └── 范围: [0, 1]
    │
    └── 结果保存
        │
        ├── CSV格式保存
        │   ├── 多次运行结果
        │   ├── 平均值计算
        │   └── 标准差计算
        │
        └── 统计分析
            ├── 性能对比
            ├── 显著性检验
            └── 可视化分析
```

这个详细的数据流图展示了UMC项目从数据输入到最终结果输出的完整技术流程，包括每个阶段的具体实现细节、数据维度变化、关键算法和优化策略。通过这个可视化图表，可以更直观地理解整个系统的数据流向和处理过程。
